################################################################################
# Provision DBA Assessment Environment
#
# This is the candidate's entry point. They run this workflow from the Actions
# tab with their invite code to provision a dedicated MySQL environment (1
# primary + 2 replicas) on AWS.
#
# Prerequisites (set by admin CLI when creating the candidate repo):
#   - secrets.AWS_ROLE_ARN : IAM role ARN for OIDC authentication
################################################################################

name: Provision Assessment Environment

on:
  workflow_dispatch:
    inputs:
      invite_code:
        description: "Your assessment invite code (e.g., DBA-K7X2M9PQ)"
        required: true
        type: string

# Cancel any in-progress runs of this workflow
concurrency:
  group: provision-${{ github.repository }}
  cancel-in-progress: false

jobs:
  provision-environment:
    name: Provision Environment
    runs-on: ubuntu-latest

    permissions:
      id-token: write    # OIDC authentication with AWS
      contents: write    # Push progress.json updates

    env:
      AWS_REGION: af-south-1
      LAMBDA_FUNCTION: dba-assessment-provisioner

    steps:
      # ------------------------------------------------------------------
      # 1. Checkout repository
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # 2. Configure AWS credentials via OIDC
      # ------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ------------------------------------------------------------------
      # 3. Validate invite code format
      # ------------------------------------------------------------------
      - name: Validate invite code format
        env:
          INVITE_CODE: ${{ inputs.invite_code }}
        run: |
          if [[ ! "$INVITE_CODE" =~ ^DBA-[A-Z0-9]{8}$ ]]; then
            echo "::error::Invalid invite code format."
            echo "Expected format: DBA-XXXXXXXX (where X is uppercase letter or digit)"

            {
              echo "## Invite Code Validation Failed"
              echo ""
              echo "The provided invite code does not match the expected format."
              echo ""
              echo "**Expected format:** \`DBA-XXXXXXXX\` (8 uppercase alphanumeric characters)"
              echo ""
              echo "Please check your invite email and try again."
            } >> "$GITHUB_STEP_SUMMARY"

            exit 1
          fi
          echo "Invite code format is valid."

      # ------------------------------------------------------------------
      # 4. Invoke provisioner Lambda
      # ------------------------------------------------------------------
      - name: Invoke provisioner Lambda
        id: invoke-lambda
        env:
          INVITE_CODE: ${{ inputs.invite_code }}
          REPO_NAME: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
        run: |
          echo "Invoking provisioner Lambda..."

          PAYLOAD=$(jq -n \
            --arg invite_code "$INVITE_CODE" \
            --arg repo_name "$REPO_NAME" \
            --arg github_actor "$ACTOR" \
            '{
              invite_code: $invite_code,
              repo_name: $repo_name,
              github_actor: $github_actor
            }')

          # Use a long read timeout because provisioning runs OpenTofu
          # which can take several minutes. Without this, the AWS CLI
          # defaults to 60s, times out, retries, and the retry hits a
          # 409 because the invite code was already claimed.
          aws lambda invoke \
            --function-name "$LAMBDA_FUNCTION" \
            --cli-binary-format raw-in-base64-out \
            --cli-read-timeout 900 \
            --payload "$PAYLOAD" \
            --region "$AWS_REGION" \
            /tmp/lambda-response.json

          echo "Lambda invocation complete."

      # ------------------------------------------------------------------
      # 5. Parse Lambda response
      # ------------------------------------------------------------------
      - name: Parse Lambda response
        id: parse-response
        run: |
          RESPONSE=$(cat /tmp/lambda-response.json)
          echo "Lambda response: $RESPONSE"

          # Check for Lambda runtime errors (unhandled exception)
          if echo "$RESPONSE" | jq -e '.errorMessage' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.errorMessage')
            echo "::error::Lambda execution failed: $ERROR_MSG"

            {
              echo "## Provisioning Failed"
              echo ""
              echo "The provisioner Lambda returned an error:"
              echo ""
              echo "> $ERROR_MSG"
              echo ""
              echo "### Troubleshooting"
              echo ""
              echo "- **Invalid invite code**: Double-check the code from your invite email."
              echo "- **Code already used**: Each invite code can only be used once. Contact the assessment administrator if you believe this is an error."
              echo "- **Service issue**: If the problem persists, please contact support."
            } >> "$GITHUB_STEP_SUMMARY"

            exit 1
          fi

          # Check for application-level errors (non-200 statusCode or .error field)
          STATUS_CODE=$(echo "$RESPONSE" | jq -r '.statusCode // 200')
          if [[ "$STATUS_CODE" != "200" ]]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error // .message // "Unknown error"')
            echo "::error::Provisioning failed (HTTP $STATUS_CODE): $ERROR_MSG"

            {
              echo "## Provisioning Failed"
              echo ""
              echo "**Error:** $ERROR_MSG"
              echo ""
              echo "### Troubleshooting"
              echo ""
              echo "- **Invalid invite code**: Verify the code matches what you received."
              echo "- **Code already used**: Each code is single-use. Contact your assessment administrator."
              echo "- **Environment limit reached**: There may be a capacity constraint. Try again in a few minutes."
            } >> "$GITHUB_STEP_SUMMARY"

            exit 1
          fi

          # Extract connection details from successful response
          PRIMARY_IP=$(echo "$RESPONSE" | jq -r '.primary_ip // empty')
          REPLICA_IPS_CSV=$(echo "$RESPONSE" | jq -r '(.replica_ips // []) | join(", ")')
          SSH_KEY_PATH=$(echo "$RESPONSE" | jq -r '.ssh_key_ssm_path // empty')
          SSH_PRIVATE_KEY=$(echo "$RESPONSE" | jq -r '.ssh_private_key // empty')
          ENVIRONMENT_ID=$(echo "$RESPONSE" | jq -r '.environment_id // empty')
          EXPIRES_AT=$(echo "$RESPONSE" | jq -r '.expires_at // "24 hours from now"')

          echo "primary_ip=$PRIMARY_IP" >> "$GITHUB_OUTPUT"
          echo "replica_ips=$REPLICA_IPS_CSV" >> "$GITHUB_OUTPUT"
          echo "ssh_key_path=$SSH_KEY_PATH" >> "$GITHUB_OUTPUT"
          echo "environment_id=$ENVIRONMENT_ID" >> "$GITHUB_OUTPUT"
          echo "expires_at=$EXPIRES_AT" >> "$GITHUB_OUTPUT"

          # Store SSH key for artifact upload
          if [[ -n "$SSH_PRIVATE_KEY" ]]; then
            echo "$SSH_PRIVATE_KEY" > /tmp/ssh-key.pem
            chmod 600 /tmp/ssh-key.pem
          fi

          echo "Environment provisioned successfully."

      # ------------------------------------------------------------------
      # 6. Upload SSH private key as downloadable artifact
      # ------------------------------------------------------------------
      - name: Upload SSH key artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ssh-key
          path: /tmp/ssh-key.pem
          retention-days: 7
          if-no-files-found: warn

      # ------------------------------------------------------------------
      # 7. Output connection summary
      # ------------------------------------------------------------------
      - name: Write connection summary
        if: success()
        env:
          PRIMARY_IP: ${{ steps.parse-response.outputs.primary_ip }}
          REPLICA_IPS: ${{ steps.parse-response.outputs.replica_ips }}
          EXPIRES_AT: ${{ steps.parse-response.outputs.expires_at }}
        run: |
          {
            echo "## Assessment Environment Provisioned"
            echo ""
            echo "Your DBA assessment environment is ready!"
            echo ""
            echo "### Connection Details"
            echo ""
            echo "| Resource | Address |"
            echo "|----------|---------|"
            echo "| **Primary MySQL** | \`$PRIMARY_IP\` |"
          } >> "$GITHUB_STEP_SUMMARY"

          # Split replica IPs and add each as a row
          IFS=', ' read -ra REPLICAS <<< "$REPLICA_IPS"
          for i in "${!REPLICAS[@]}"; do
            echo "| **Replica $((i+1))** | \`${REPLICAS[$i]}\` |" >> "$GITHUB_STEP_SUMMARY"
          done

          {
            echo ""
            echo "### SSH Access"
            echo ""
            echo "1. Download the SSH key from the **Artifacts** section below."
            echo "2. Set correct permissions:"
            echo '   ```bash'
            echo '   chmod 600 ssh-key.pem'
            echo '   ```'
            echo "3. Connect to the primary instance:"
            echo '   ```bash'
            echo "   ssh -i ssh-key.pem ubuntu@$PRIMARY_IP"
            echo '   ```'
            echo "4. Connect to replicas:"
          } >> "$GITHUB_STEP_SUMMARY"

          for i in "${!REPLICAS[@]}"; do
            {
              echo '   ```bash'
              echo "   ssh -i ssh-key.pem ubuntu@${REPLICAS[$i]}"
              echo '   ```'
            } >> "$GITHUB_STEP_SUMMARY"
          done

          {
            echo ""
            echo "### Important Notes"
            echo ""
            echo "- Your environment will expire at **$EXPIRES_AT**."
            echo "- MySQL is pre-installed on the primary with a deliberately misconfigured setup."
            echo "- Replicas have bare Ubuntu -- you will set up MySQL replication yourself."
            echo "- Use the **Request Validation** workflow to check your work as you complete each step."
            echo ""
            echo "### Next Steps"
            echo ""
            echo '1. Read the assessment instructions in `docs/`.'
            echo "2. SSH into the primary instance and begin Step 1."
            echo '3. Document your work in `submissions/step-N.md`.'
            echo "4. Run **Request Validation** when ready to have a step checked."
          } >> "$GITHUB_STEP_SUMMARY"
